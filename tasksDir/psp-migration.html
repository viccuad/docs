<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-tasksDir/psp-migration">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-56382716-13","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-rh="true">Kubewarden ¬∑ Kubernetes Dynamic Admission at your fingertips</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.kubewarden.io/tasksDir/psp-migration"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="description" content="With the removal of PodSecurityPolicy"><meta data-rh="true" property="og:description" content="With the removal of PodSecurityPolicy"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.kubewarden.io/tasksDir/psp-migration"><link data-rh="true" rel="alternate" href="https://docs.kubewarden.io/tasksDir/psp-migration" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.kubewarden.io/tasksDir/psp-migration" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.5eecb69e.css">
<link rel="preload" href="/assets/js/runtime~main.c0bb628d.js" as="script">
<link rel="preload" href="/assets/js/main.43579c1c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/icon-kubewarden.svg" alt="logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/icon-kubewarden.svg" alt="logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link navbar__docs navbar__link--active" href="/">Docs</a><a href="https://github.com/kubewarden/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__github btn btn-secondary icon-github">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/quick-start">Quick Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/tasks">Common Tasks</a><button aria-label="Toggle the collapsible sidebar category &#x27;Common Tasks&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/tasksDir/mutating-policies">Mutating Policies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/tasksDir/psp-migration">PSP Migration</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/writing-policies">Writing Policies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Writing Policies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/writing-policies/rust/intro-rust">Supported Languages</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/writing-policies/rego/open-policy-agent/intro">Supported Frameworks</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/distributing-policies">Distributing Policies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Distributing Policies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/testing-policies/intro">Testing Policies</a><button aria-label="Toggle the collapsible sidebar category &#x27;Testing Policies&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/operator-manual/intro">Operator Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Operator Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/">üè†</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/tasks"><span itemprop="name">Common Tasks</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">PSP Migration</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>PSP Migration</h1><p>With the removal of <a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/" target="_blank" rel="noopener noreferrer">PodSecurityPolicy</a>
in Kubernetes v1.25, you can leverage Kubewarden for admission control on your Kubernetes clusters.
Contrasting with the PSPs, Kubewarden has separate policies to achieve the same goal. Therefore, each Kubewarden policy could be likened to a different
configuration within the spec of a PSP. A mapping of the PSP configuration fields to their respective policies can be found below
in the <a href="#mapping-kuberwarden-policies-to-psp-fields">mapping table</a>. Therefore, the operators have more granular control
of the configuration they want to apply in their clusters. If they want to apply part of the PSP security checks it
is not necessary to define the configurations related to the other fields.</p><p>Once you have the Kubewarden instance running, it&#x27;s time to deploy some policies to replace the <code>PodSecurityPolicy</code> object. Start by listing
the PSPs in use. For the sake of this example, the following enforcements have been considered:</p><ul><li>a PSP disabling privileged escalation</li><li>privileged containers</li><li>blocking pods running as root</li><li>forcing a particular user group</li><li>blocking host namespaces</li><li>allowing pod to use the port 443 only</li></ul><p>The yaml definition of the aforementioned PSP would look like the below:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: policy/v1beta1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: PodSecurityPolicy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: restricted</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  allowPrivilegeEscalation: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  runAsUser:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    rule: MustRunAsNonRoot</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  supplementalGroups:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    rule: MustRunAs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ranges:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - min: 1000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        max: 65535</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  privileged: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostNetwork: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostIPC: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostPID: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostPorts:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - min: 443</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      max: 443</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Let&#x27;s create Kubewarden policies to achieve the same goal. One thing that you need to know about Kubewarden policies is that every rule will be enforced by a separate policy. In our example, individual policies will be required for the enforcement of user and group configuration, host namespaces,  privileged escalation, and for the privileged container configuration.</p><p>Let&#x27;s start with blocking container escalation. For that you can deploy a policy as shown below:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: policies.kubewarden.io/v1alpha2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: ClusterAdmissionPolicy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: psp-allowprivilegeescalation</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  module: registry://ghcr.io/kubewarden/policies/allow-privilege-escalation-psp:v0.1.11</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - apiGroups:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      apiVersions:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      resources:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - pods</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      operations:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - CREATE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - UPDATE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  mutating: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  settings:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    default_allow_privilege_escalation: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>If you notice, we have specified <code>default_allow_privilege_escalation</code> to assume a value <code>false</code>. Once this policy starts running, it will restrict pods trying to run with more privileges than the parent container by default.</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    securityContext:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      allowPrivilegeEscalation: true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: sidecar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: sidecar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Error from server: error when creating &quot;STDIN&quot;: admission webhook &quot;clusterwide-psp-allowprivilegeescalation.kubewarden.admission&quot; denied the request: one of the containers has privilege escalation enabled</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Now, to enforce the user and groups configuration, you can use the <a href="https://github.com/kubewarden/user-group-psp-policy" target="_blank" rel="noopener noreferrer">user-group-psp policy</a></p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: policies.kubewarden.io/v1alpha2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: ClusterAdmissionPolicy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: psp-usergroup</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  module: registry://ghcr.io/kubewarden/policies/user-group-psp:v0.2.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - apiGroups:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      apiVersions:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      resources:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - pods</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      operations:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - CREATE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - UPDATE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  mutating: true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  settings:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    run_as_user:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      rule: MustRunAsNonRoot</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    supplemental_groups:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      rule: MustRunAs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      ranges:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - min: 1000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          max: 65535</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Notice the policy is configured as <code>mutation: true</code>. This is required because the policy will add <a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#users-and-groups" target="_blank" rel="noopener noreferrer">supplementalGroups</a> when the user does not define them.</p><p>So, now users cannot deploy pods running as root:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    securityContext:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      runAsNonRoot: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      runAsUser: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Error from server: error when creating &quot;STDIN&quot;: admission webhook &quot;clusterwide-psp-usergroup-fb836.kubewarden.admission&quot; denied the request: RunAsNonRoot should be set to true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    securityContext:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      runAsNonRoot: true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      runAsUser: 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Error from server: error when creating &quot;STDIN&quot;: admission webhook &quot;clusterwide-psp-usergroup-fb836.kubewarden.admission&quot; denied the request: Invalid user ID: cannot run container with root ID (0)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Also, the example below also demonstrates the addition of a <a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#users-and-groups" target="_blank" rel="noopener noreferrer">Supplemental group</a>, despite it not being defined by us.</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pod/nginx created</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl get pods -o json nginx | jq &quot;.spec.securityContext&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">{</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;supplementalGroups&quot;: [</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    10000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>To replace the PSP configuration that blocks privileged containers, it&#x27;s necessary to deploy the <a href="https://github.com/kubewarden/pod-privileged-policy" target="_blank" rel="noopener noreferrer">pod-privileged policy</a>. This policy does not require any settings. Once running, it will block privileged pods.</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: policies.kubewarden.io/v1alpha2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: ClusterAdmissionPolicy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: psp-privileged</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  module: registry://ghcr.io/kubewarden/policies/pod-privileged:v0.1.10</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - apiGroups:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      apiVersions:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      resources:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - pods</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      operations:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - CREATE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - UPDATE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  mutating: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  settings: null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>To test the policy, we can try running a pod with privileged configuration enabled:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    securityContext:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      privileged: true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: sleeping-sidecar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: alpine</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    command: [&quot;sleep&quot;, &quot;1h&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Error from server: error when creating &quot;STDIN&quot;: admission webhook &quot;clusterwide-psp-privileged.kubewarden.admission&quot; denied the request: User &#x27;system:admin&#x27; cannot schedule privileged containers</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>To complete the PSP migration exercise, it&#x27;s necessary to disable host namespace sharing.
To do that, we shall be using the <a href="https://github.com/kubewarden/host-namespaces-psp-policy" target="_blank" rel="noopener noreferrer"><code>host-namespace-psp</code> policy</a>.
It allows the cluster administrator to block IPC, PID, and network namespaces individually and set the ports
that the pods can be exposed on the host IP.</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: policies.kubewarden.io/v1alpha2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: ClusterAdmissionPolicy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: psp-hostnamespaces</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  module: registry://ghcr.io/kubewarden/policies/host-namespaces-psp:v0.1.2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  rules:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - apiGroups:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      apiVersions:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      resources:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - pods</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      operations:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - CREATE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - UPDATE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  mutating: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  settings:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    allow_host_ipc: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    allow_host_pid: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    allow_host_ports:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - min: 443</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        max: 443</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    allow_host_network: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Again, let&#x27;s validate the policy. The pod should not be able to share host namespaces:</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostIPC: true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostNetwork: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostPID: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: sleeping-sidecar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: alpine</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    command: [&quot;sleep&quot;, &quot;1h&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Error from server: error when creating &quot;STDIN&quot;: admission webhook &quot;clusterwide-psp-hostnamespaces.kubewarden.admission&quot; denied the request: Pod has IPC enabled, but this is not allowed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostIPC: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostNetwork: true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostPID: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: sleeping-sidecar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: alpine</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    command: [&quot;sleep&quot;, &quot;1h&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Error from server: error when creating &quot;STDIN&quot;: admission webhook &quot;clusterwide-psp-hostnamespaces.kubewarden.admission&quot; denied the request: Pod has host network enabled, but this is not allowed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostIPC: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostNetwork: false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  hostPID: true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: sleeping-sidecar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: alpine</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    command: [&quot;sleep&quot;, &quot;1h&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Error from server: error when creating &quot;STDIN&quot;: admission webhook &quot;clusterwide-psp-hostnamespaces.kubewarden.admission&quot; denied the request: Pod has host PID enabled, but this is not allowed</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>The pod should be only able to expose the port 443 and should throw an error when other port numbers are configured against the hostPort section.</p><div class="codeBlockContainer_I0IT language-console theme-code-block"><div class="codeBlockContent_wNvx" style="color:#bfc7d5;background-color:#292d3e"><pre tabindex="0" class="prism-code language-console codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ kubectl apply -f - &lt;&lt;EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Pod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  containers:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: nginx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - containerPort: 80</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        hostPort: 80</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: sleeping-sidecar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: alpine</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    command: [&quot;sleep&quot;, &quot;1h&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Error from server: error when creating &quot;STDIN&quot;: admission webhook &quot;clusterwide-psp-hostnamespaces.kubewarden.admission&quot; denied the request: Pod is using unallowed host ports in containers</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="mapping-kuberwarden-policies-to-psp-fields">Mapping Kuberwarden policies to PSP fields<a class="hash-link" href="#mapping-kuberwarden-policies-to-psp-fields" title="Direct link to heading">‚Äã</a></h2><p>The following table show which Kubewarden policy can be used to replace each PSP configuration</p><table><thead><tr><th>PSP field</th><th>Kubewarden equivalent policy</th></tr></thead><tbody><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#privileged" target="_blank" rel="noopener noreferrer">privileged</a></td><td><a href="https://github.com/kubewarden/pod-privileged-policy" target="_blank" rel="noopener noreferrer">pod-privileged-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#host-namespaces" target="_blank" rel="noopener noreferrer">hostPID</a></td><td><a href="https://github.com/kubewarden/host-namespaces-psp-policy" target="_blank" rel="noopener noreferrer">host-namespaces-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#host-namespaces" target="_blank" rel="noopener noreferrer">hostIPC</a></td><td><a href="https://github.com/kubewarden/host-namespaces-psp-policy" target="_blank" rel="noopener noreferrer">host-namespaces-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#host-namespaces" target="_blank" rel="noopener noreferrer">hostNetwork</a></td><td><a href="https://github.com/kubewarden/host-namespaces-psp-policy" target="_blank" rel="noopener noreferrer">host-namespaces-psp-polic</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#host-namespaces" target="_blank" rel="noopener noreferrer">hostPorts</a></td><td><a href="https://github.com/kubewarden/host-namespaces-psp-policy" target="_blank" rel="noopener noreferrer">host-namespaces-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#volumes-and-file-systems" target="_blank" rel="noopener noreferrer">volumes</a></td><td><a href="https://github.com/kubewarden/volumes-psp-policy" target="_blank" rel="noopener noreferrer">volumes-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#volumes-and-file-systems" target="_blank" rel="noopener noreferrer">allowedHostPaths</a></td><td><a href="https://github.com/kubewarden/hostpaths-psp-policy" target="_blank" rel="noopener noreferrer">hostpaths-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#volumes-and-file-systems" target="_blank" rel="noopener noreferrer">readOnlyRootFilesystem</a></td><td><a href="https://github.com/kubewarden/readonly-root-filesystem-psp-policy" target="_blank" rel="noopener noreferrer">readonly-root-filesystem-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#volumes-and-file-systems" target="_blank" rel="noopener noreferrer">fsgroup</a></td><td><a href="https://github.com/kubewarden/allowed-fsgroups-psp-policy" target="_blank" rel="noopener noreferrer">allowed-fsgroups-psp-policy </a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#flexvolume-drivers" target="_blank" rel="noopener noreferrer">allowedFlexVolumes</a></td><td><a href="https://github.com/kubewarden/flexvolume-drivers-psp-policy" target="_blank" rel="noopener noreferrer">flexvolume-drivers-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#users-and-groups" target="_blank" rel="noopener noreferrer">runAsUser</a></td><td><a href="https://github.com/kubewarden/user-group-psp-policy" target="_blank" rel="noopener noreferrer">user-group-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#users-and-groups" target="_blank" rel="noopener noreferrer">runAsGroup</a></td><td><a href="https://github.com/kubewarden/user-group-psp-policy" target="_blank" rel="noopener noreferrer">user-group-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#users-and-groups" target="_blank" rel="noopener noreferrer">supplementalGroups</a></td><td><a href="https://github.com/kubewarden/user-group-psp-policy" target="_blank" rel="noopener noreferrer">user-group-psp-policy </a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#privilege-escalation" target="_blank" rel="noopener noreferrer">allowPrivilegeEscalation</a></td><td><a href="https://github.com/kubewarden/allow-privilege-escalation-psp-policy" target="_blank" rel="noopener noreferrer">allow-privilege-escalation-psp-policy </a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#privilege-escalation" target="_blank" rel="noopener noreferrer">defaultAllowPrivilegeEscalation</a></td><td><a href="https://github.com/kubewarden/allow-privilege-escalation-psp-policy" target="_blank" rel="noopener noreferrer">allow-privilege-escalation-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#capabilities" target="_blank" rel="noopener noreferrer">allowedCapabilities</a></td><td><a href="https://github.com/kubewarden/capabilities-psp-policy" target="_blank" rel="noopener noreferrer">capabilities-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#capabilities" target="_blank" rel="noopener noreferrer">defaultAddCapabilities</a></td><td><a href="https://github.com/kubewarden/capabilities-psp-policy" target="_blank" rel="noopener noreferrer">capabilities-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#capabilities" target="_blank" rel="noopener noreferrer">requiredDropCapabilities</a></td><td><a href="https://github.com/kubewarden/capabilities-psp-policy" target="_blank" rel="noopener noreferrer">capabilities-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#selinux" target="_blank" rel="noopener noreferrer">seLinux</a></td><td><a href="https://github.com/kubewarden/selinux-psp-policy" target="_blank" rel="noopener noreferrer">selinux-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#allowedprocmounttypes" target="_blank" rel="noopener noreferrer">allowedProcMountTypes</a></td><td><a href="https://github.com/kubewarden/allowed-proc-mount-types-psp-policy" target="_blank" rel="noopener noreferrer">allowed-proc-mount-types-psp-policy</a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#apparmor" target="_blank" rel="noopener noreferrer">apparmor</a></td><td><a href="https://github.com/kubewarden/apparmor-psp-policy" target="_blank" rel="noopener noreferrer">apparmor-psp-policy </a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#apparmor" target="_blank" rel="noopener noreferrer">seccomp</a></td><td><a href="https://github.com/kubewarden/seccomp-psp-policy" target="_blank" rel="noopener noreferrer">seccomp-psp-policy </a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#apparmor" target="_blank" rel="noopener noreferrer">forbiddenSysctls</a></td><td><a href="https://github.com/kubewarden/sysctl-psp-policy" target="_blank" rel="noopener noreferrer">sysctl-psp-policy </a></td></tr><tr><td><a href="https://kubernetes.io/docs/concepts/security/pod-security-policy/#apparmor" target="_blank" rel="noopener noreferrer">allowedUnsafeSysctls</a></td><td><a href="https://github.com/kubewarden/sysctl-psp-policy" target="_blank" rel="noopener noreferrer">sysctl-psp-policy </a></td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/kubewarden/docs/edit/main/docs/tasksDir/psp-migration.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-06-02T09:19:47.000Z">6/2/2022</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/tasksDir/mutating-policies"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Mutating Policies</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/architecture"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Architecture</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#mapping-kuberwarden-policies-to-psp-fields" class="table-of-contents__link toc-highlight">Mapping Kuberwarden policies to PSP fields</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 SUSE Rancher. All Rights Reserved.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c0bb628d.js"></script>
<script src="/assets/js/main.43579c1c.js"></script>
</body>
</html>